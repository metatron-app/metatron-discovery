"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.coordHasLength4 = coordHasLength4;
exports.containValidTime = containValidTime;
exports.isTripGeoJsonField = isTripGeoJsonField;
exports.parseTripGeoJsonTimestamp = parseTripGeoJsonTimestamp;
exports.getAnimationDomainFromTimestamps = getAnimationDomainFromTimestamps;

var _typeAnalyzer = require("type-analyzer");

var _dataUtils = require("../../utils/data-utils");

var _geojsonUtils = require("../geojson-layer/geojson-utils");

// Copyright (c) 2020 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

/**
 * Parse geojson from string
 * @param {array} samples feature object values
 * @returns {boolean} whether the geometry coordinates has length of 4
 */
function coordHasLength4(samples) {
  var hasLength4 = true;

  for (var i = 0; i < samples.length; i += 1) {
    hasLength4 = !samples[i].geometry.coordinates.find(function (c) {
      return c.length < 4;
    });

    if (!hasLength4) {
      break;
    }
  }

  return hasLength4;
}
/**
 * Check whether geojson linestring's 4th coordinate is 1) not timestamp 2) unix time stamp 3) real date time
 * @param {array} timestamps array to be tested if its elements are timestamp
 * @returns {object | boolean} the type of timestamp: unix/datetime/invalid(not timestamp)
 */


function containValidTime(timestamps) {
  var formattedTimeStamps = timestamps.map(function (ts) {
    return {
      ts: ts
    };
  });
  var ignoredDataTypes = Object.keys(_typeAnalyzer.DATA_TYPES).filter(function (type) {
    return ![_typeAnalyzer.DATA_TYPES.TIME, _typeAnalyzer.DATA_TYPES.DATETIME].includes(type);
  }); // ignore all types but TIME to improve performance

  var analyzedType = _typeAnalyzer.Analyzer.computeColMeta(formattedTimeStamps, [], {
    ignoredDataTypes: ignoredDataTypes
  })[0];

  if (!analyzedType || analyzedType.category !== 'TIME') {
    return false;
  }

  return analyzedType;
}
/**
 * Check if geojson features are trip layer animatable by meeting 3 conditions
 * @param {array} allData array of geojson feature objects
 * @param {object} field array of geojson feature objects
 * @returns {boolean} whether it is trip layer animatable
 */


function isTripGeoJsonField() {
  var allData = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var field = arguments.length > 1 ? arguments[1] : undefined;

  if (!allData.length) {
    return false;
  }

  var getValue = function getValue(d) {
    return d[field.tableFieldIndex - 1];
  };

  var maxCount = 10000;
  var sampleRawFeatures = allData.length > maxCount ? (0, _dataUtils.getSampleData)(allData, maxCount, getValue) : allData.map(getValue);
  var features = sampleRawFeatures.map(_geojsonUtils.parseGeoJsonRawFeature).filter(function (f) {
    return f;
  });
  var featureTypes = (0, _geojsonUtils.getGeojsonFeatureTypes)(features); // condition 1: contain line string

  if (!featureTypes.line) {
    return false;
  } // condition 2:sample line strings contain 4 coordinates


  if (!coordHasLength4(features)) {
    return false;
  } // condition 3:the 4th coordinate of the first feature line strings is valid time


  var tsHolder = features[0].geometry.coordinates.map(function (coord) {
    return coord[3];
  });
  return Boolean(containValidTime(tsHolder));
}
/**
 * Get unix timestamp from animatable geojson for deck.gl trip layer
 * @param {Array<Object>} dataToFeature array of geojson feature objects, can be null
 * @returns {{dataToTimeStamp: Array[Number], animationDomain: null | Array<Number>}} {dataToTimeStamp: [], animationDomain: null}
 */


function parseTripGeoJsonTimestamp(dataToFeature) {
  // Analyze type based on coordinates of the 1st lineString
  // select a sample trip to analyze time format
  var empty = {
    dataToTimeStamp: [],
    animationDomain: null
  };
  var sampleTrip = dataToFeature.find(function (f) {
    return f && f.geometry && f.geometry.coordinates && f.geometry.coordinates.length >= 3;
  }); // if no valid geometry

  if (!sampleTrip) {
    return empty;
  }

  var analyzedType = containValidTime(sampleTrip.geometry.coordinates.map(function (coord) {
    return coord[3];
  }));

  if (!analyzedType) {
    return empty;
  }

  var format = analyzedType.format;

  var getTimeValue = function getTimeValue(coord) {
    return coord && (0, _dataUtils.notNullorUndefined)(coord[3]) ? (0, _dataUtils.timeToUnixMilli)(coord[3], format) : null;
  };

  var dataToTimeStamp = dataToFeature.map(function (f) {
    return f && f.geometry && Array.isArray(f.geometry.coordinates) ? f.geometry.coordinates.map(getTimeValue) : null;
  });
  var animationDomain = getAnimationDomainFromTimestamps(dataToTimeStamp);
  return {
    dataToTimeStamp: dataToTimeStamp,
    animationDomain: animationDomain
  };
}

function findMinFromSorted() {
  var list = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  return list.find(function (d) {
    return (0, _dataUtils.notNullorUndefined)(d) && Number.isFinite(d);
  }) || null;
}

function findMaxFromSorted() {
  var list = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var i = list.length - 1;

  while (i > 0) {
    if ((0, _dataUtils.notNullorUndefined)(list[i]) && Number.isFinite(list[i])) {
      return list[i];
    }

    i--;
  }

  return null;
}

function getAnimationDomainFromTimestamps() {
  var dataToTimeStamp = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  return dataToTimeStamp.reduce(function (accu, tss) {
    var tsMin = findMinFromSorted(tss);
    var tsMax = findMaxFromSorted(tss);

    if (Number.isFinite(tsMin) && Number.isFinite(tsMax)) {
      accu[0] = Math.min(accu[0], tsMin);
      accu[1] = Math.max(accu[1], tsMax);
    }

    return accu;
  }, [Infinity, -Infinity]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYXllcnMvdHJpcC1sYXllci90cmlwLXV0aWxzLmpzIl0sIm5hbWVzIjpbImNvb3JkSGFzTGVuZ3RoNCIsInNhbXBsZXMiLCJoYXNMZW5ndGg0IiwiaSIsImxlbmd0aCIsImdlb21ldHJ5IiwiY29vcmRpbmF0ZXMiLCJmaW5kIiwiYyIsImNvbnRhaW5WYWxpZFRpbWUiLCJ0aW1lc3RhbXBzIiwiZm9ybWF0dGVkVGltZVN0YW1wcyIsIm1hcCIsInRzIiwiaWdub3JlZERhdGFUeXBlcyIsIk9iamVjdCIsImtleXMiLCJEQVRBX1RZUEVTIiwiZmlsdGVyIiwidHlwZSIsIlRJTUUiLCJEQVRFVElNRSIsImluY2x1ZGVzIiwiYW5hbHl6ZWRUeXBlIiwiQW5hbHl6ZXIiLCJjb21wdXRlQ29sTWV0YSIsImNhdGVnb3J5IiwiaXNUcmlwR2VvSnNvbkZpZWxkIiwiYWxsRGF0YSIsImZpZWxkIiwiZ2V0VmFsdWUiLCJkIiwidGFibGVGaWVsZEluZGV4IiwibWF4Q291bnQiLCJzYW1wbGVSYXdGZWF0dXJlcyIsImZlYXR1cmVzIiwicGFyc2VHZW9Kc29uUmF3RmVhdHVyZSIsImYiLCJmZWF0dXJlVHlwZXMiLCJsaW5lIiwidHNIb2xkZXIiLCJjb29yZCIsIkJvb2xlYW4iLCJwYXJzZVRyaXBHZW9Kc29uVGltZXN0YW1wIiwiZGF0YVRvRmVhdHVyZSIsImVtcHR5IiwiZGF0YVRvVGltZVN0YW1wIiwiYW5pbWF0aW9uRG9tYWluIiwic2FtcGxlVHJpcCIsImZvcm1hdCIsImdldFRpbWVWYWx1ZSIsIkFycmF5IiwiaXNBcnJheSIsImdldEFuaW1hdGlvbkRvbWFpbkZyb21UaW1lc3RhbXBzIiwiZmluZE1pbkZyb21Tb3J0ZWQiLCJsaXN0IiwiTnVtYmVyIiwiaXNGaW5pdGUiLCJmaW5kTWF4RnJvbVNvcnRlZCIsInJlZHVjZSIsImFjY3UiLCJ0c3MiLCJ0c01pbiIsInRzTWF4IiwiTWF0aCIsIm1pbiIsIm1heCIsIkluZmluaXR5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQW9CQTs7QUFFQTs7QUFFQTs7QUF4QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBUUE7Ozs7O0FBS08sU0FBU0EsZUFBVCxDQUF5QkMsT0FBekIsRUFBa0M7QUFDdkMsTUFBSUMsVUFBVSxHQUFHLElBQWpCOztBQUNBLE9BQUssSUFBSUMsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR0YsT0FBTyxDQUFDRyxNQUE1QixFQUFvQ0QsQ0FBQyxJQUFJLENBQXpDLEVBQTRDO0FBQzFDRCxJQUFBQSxVQUFVLEdBQUcsQ0FBQ0QsT0FBTyxDQUFDRSxDQUFELENBQVAsQ0FBV0UsUUFBWCxDQUFvQkMsV0FBcEIsQ0FBZ0NDLElBQWhDLENBQXFDLFVBQUFDLENBQUM7QUFBQSxhQUFJQSxDQUFDLENBQUNKLE1BQUYsR0FBVyxDQUFmO0FBQUEsS0FBdEMsQ0FBZDs7QUFDQSxRQUFJLENBQUNGLFVBQUwsRUFBaUI7QUFDZjtBQUNEO0FBQ0Y7O0FBQ0QsU0FBT0EsVUFBUDtBQUNEO0FBRUQ7Ozs7Ozs7QUFNTyxTQUFTTyxnQkFBVCxDQUEwQkMsVUFBMUIsRUFBc0M7QUFDM0MsTUFBTUMsbUJBQW1CLEdBQUdELFVBQVUsQ0FBQ0UsR0FBWCxDQUFlLFVBQUFDLEVBQUU7QUFBQSxXQUFLO0FBQUNBLE1BQUFBLEVBQUUsRUFBRkE7QUFBRCxLQUFMO0FBQUEsR0FBakIsQ0FBNUI7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBR0MsTUFBTSxDQUFDQyxJQUFQLENBQVlDLHdCQUFaLEVBQXdCQyxNQUF4QixDQUN2QixVQUFBQyxJQUFJO0FBQUEsV0FBSSxDQUFDLENBQUNGLHlCQUFXRyxJQUFaLEVBQWtCSCx5QkFBV0ksUUFBN0IsRUFBdUNDLFFBQXZDLENBQWdESCxJQUFoRCxDQUFMO0FBQUEsR0FEbUIsQ0FBekIsQ0FGMkMsQ0FNM0M7O0FBQ0EsTUFBTUksWUFBWSxHQUFHQyx1QkFBU0MsY0FBVCxDQUF3QmQsbUJBQXhCLEVBQTZDLEVBQTdDLEVBQWlEO0FBQUNHLElBQUFBLGdCQUFnQixFQUFoQkE7QUFBRCxHQUFqRCxFQUFxRSxDQUFyRSxDQUFyQjs7QUFFQSxNQUFJLENBQUNTLFlBQUQsSUFBaUJBLFlBQVksQ0FBQ0csUUFBYixLQUEwQixNQUEvQyxFQUF1RDtBQUNyRCxXQUFPLEtBQVA7QUFDRDs7QUFDRCxTQUFPSCxZQUFQO0FBQ0Q7QUFFRDs7Ozs7Ozs7QUFNTyxTQUFTSSxrQkFBVCxHQUFpRDtBQUFBLE1BQXJCQyxPQUFxQix1RUFBWCxFQUFXO0FBQUEsTUFBUEMsS0FBTzs7QUFDdEQsTUFBSSxDQUFDRCxPQUFPLENBQUN4QixNQUFiLEVBQXFCO0FBQ25CLFdBQU8sS0FBUDtBQUNEOztBQUNELE1BQU0wQixRQUFRLEdBQUcsU0FBWEEsUUFBVyxDQUFBQyxDQUFDO0FBQUEsV0FBSUEsQ0FBQyxDQUFDRixLQUFLLENBQUNHLGVBQU4sR0FBd0IsQ0FBekIsQ0FBTDtBQUFBLEdBQWxCOztBQUNBLE1BQU1DLFFBQVEsR0FBRyxLQUFqQjtBQUNBLE1BQU1DLGlCQUFpQixHQUNyQk4sT0FBTyxDQUFDeEIsTUFBUixHQUFpQjZCLFFBQWpCLEdBQTRCLDhCQUFjTCxPQUFkLEVBQXVCSyxRQUF2QixFQUFpQ0gsUUFBakMsQ0FBNUIsR0FBeUVGLE9BQU8sQ0FBQ2hCLEdBQVIsQ0FBWWtCLFFBQVosQ0FEM0U7QUFHQSxNQUFNSyxRQUFRLEdBQUdELGlCQUFpQixDQUFDdEIsR0FBbEIsQ0FBc0J3QixvQ0FBdEIsRUFBOENsQixNQUE5QyxDQUFxRCxVQUFBbUIsQ0FBQztBQUFBLFdBQUlBLENBQUo7QUFBQSxHQUF0RCxDQUFqQjtBQUNBLE1BQU1DLFlBQVksR0FBRywwQ0FBdUJILFFBQXZCLENBQXJCLENBVnNELENBWXREOztBQUNBLE1BQUksQ0FBQ0csWUFBWSxDQUFDQyxJQUFsQixFQUF3QjtBQUN0QixXQUFPLEtBQVA7QUFDRCxHQWZxRCxDQWlCdEQ7OztBQUNBLE1BQUksQ0FBQ3ZDLGVBQWUsQ0FBQ21DLFFBQUQsQ0FBcEIsRUFBZ0M7QUFDOUIsV0FBTyxLQUFQO0FBQ0QsR0FwQnFELENBc0J0RDs7O0FBQ0EsTUFBTUssUUFBUSxHQUFHTCxRQUFRLENBQUMsQ0FBRCxDQUFSLENBQVk5QixRQUFaLENBQXFCQyxXQUFyQixDQUFpQ00sR0FBakMsQ0FBcUMsVUFBQTZCLEtBQUs7QUFBQSxXQUFJQSxLQUFLLENBQUMsQ0FBRCxDQUFUO0FBQUEsR0FBMUMsQ0FBakI7QUFFQSxTQUFPQyxPQUFPLENBQUNqQyxnQkFBZ0IsQ0FBQytCLFFBQUQsQ0FBakIsQ0FBZDtBQUNEO0FBRUQ7Ozs7Ozs7QUFLTyxTQUFTRyx5QkFBVCxDQUFtQ0MsYUFBbkMsRUFBa0Q7QUFDdkQ7QUFDQTtBQUNBLE1BQU1DLEtBQUssR0FBRztBQUFDQyxJQUFBQSxlQUFlLEVBQUUsRUFBbEI7QUFBc0JDLElBQUFBLGVBQWUsRUFBRTtBQUF2QyxHQUFkO0FBQ0EsTUFBTUMsVUFBVSxHQUFHSixhQUFhLENBQUNyQyxJQUFkLENBQ2pCLFVBQUE4QixDQUFDO0FBQUEsV0FBSUEsQ0FBQyxJQUFJQSxDQUFDLENBQUNoQyxRQUFQLElBQW1CZ0MsQ0FBQyxDQUFDaEMsUUFBRixDQUFXQyxXQUE5QixJQUE2QytCLENBQUMsQ0FBQ2hDLFFBQUYsQ0FBV0MsV0FBWCxDQUF1QkYsTUFBdkIsSUFBaUMsQ0FBbEY7QUFBQSxHQURnQixDQUFuQixDQUp1RCxDQVF2RDs7QUFDQSxNQUFJLENBQUM0QyxVQUFMLEVBQWlCO0FBQ2YsV0FBT0gsS0FBUDtBQUNEOztBQUVELE1BQU10QixZQUFZLEdBQUdkLGdCQUFnQixDQUFDdUMsVUFBVSxDQUFDM0MsUUFBWCxDQUFvQkMsV0FBcEIsQ0FBZ0NNLEdBQWhDLENBQW9DLFVBQUE2QixLQUFLO0FBQUEsV0FBSUEsS0FBSyxDQUFDLENBQUQsQ0FBVDtBQUFBLEdBQXpDLENBQUQsQ0FBckM7O0FBRUEsTUFBSSxDQUFDbEIsWUFBTCxFQUFtQjtBQUNqQixXQUFPc0IsS0FBUDtBQUNEOztBQWpCc0QsTUFtQmhESSxNQW5CZ0QsR0FtQnRDMUIsWUFuQnNDLENBbUJoRDBCLE1BbkJnRDs7QUFvQnZELE1BQU1DLFlBQVksR0FBRyxTQUFmQSxZQUFlLENBQUFULEtBQUs7QUFBQSxXQUN4QkEsS0FBSyxJQUFJLG1DQUFtQkEsS0FBSyxDQUFDLENBQUQsQ0FBeEIsQ0FBVCxHQUF3QyxnQ0FBZ0JBLEtBQUssQ0FBQyxDQUFELENBQXJCLEVBQTBCUSxNQUExQixDQUF4QyxHQUE0RSxJQURwRDtBQUFBLEdBQTFCOztBQUdBLE1BQU1ILGVBQWUsR0FBR0YsYUFBYSxDQUFDaEMsR0FBZCxDQUFrQixVQUFBeUIsQ0FBQztBQUFBLFdBQ3pDQSxDQUFDLElBQUlBLENBQUMsQ0FBQ2hDLFFBQVAsSUFBbUI4QyxLQUFLLENBQUNDLE9BQU4sQ0FBY2YsQ0FBQyxDQUFDaEMsUUFBRixDQUFXQyxXQUF6QixDQUFuQixHQUNJK0IsQ0FBQyxDQUFDaEMsUUFBRixDQUFXQyxXQUFYLENBQXVCTSxHQUF2QixDQUEyQnNDLFlBQTNCLENBREosR0FFSSxJQUhxQztBQUFBLEdBQW5CLENBQXhCO0FBTUEsTUFBTUgsZUFBZSxHQUFHTSxnQ0FBZ0MsQ0FBQ1AsZUFBRCxDQUF4RDtBQUVBLFNBQU87QUFBQ0EsSUFBQUEsZUFBZSxFQUFmQSxlQUFEO0FBQWtCQyxJQUFBQSxlQUFlLEVBQWZBO0FBQWxCLEdBQVA7QUFDRDs7QUFFRCxTQUFTTyxpQkFBVCxHQUFzQztBQUFBLE1BQVhDLElBQVcsdUVBQUosRUFBSTtBQUNwQyxTQUFPQSxJQUFJLENBQUNoRCxJQUFMLENBQVUsVUFBQXdCLENBQUM7QUFBQSxXQUFJLG1DQUFtQkEsQ0FBbkIsS0FBeUJ5QixNQUFNLENBQUNDLFFBQVAsQ0FBZ0IxQixDQUFoQixDQUE3QjtBQUFBLEdBQVgsS0FBK0QsSUFBdEU7QUFDRDs7QUFFRCxTQUFTMkIsaUJBQVQsR0FBc0M7QUFBQSxNQUFYSCxJQUFXLHVFQUFKLEVBQUk7QUFDcEMsTUFBSXBELENBQUMsR0FBR29ELElBQUksQ0FBQ25ELE1BQUwsR0FBYyxDQUF0Qjs7QUFDQSxTQUFPRCxDQUFDLEdBQUcsQ0FBWCxFQUFjO0FBQ1osUUFBSSxtQ0FBbUJvRCxJQUFJLENBQUNwRCxDQUFELENBQXZCLEtBQStCcUQsTUFBTSxDQUFDQyxRQUFQLENBQWdCRixJQUFJLENBQUNwRCxDQUFELENBQXBCLENBQW5DLEVBQTZEO0FBQzNELGFBQU9vRCxJQUFJLENBQUNwRCxDQUFELENBQVg7QUFDRDs7QUFDREEsSUFBQUEsQ0FBQztBQUNGOztBQUNELFNBQU8sSUFBUDtBQUNEOztBQUVNLFNBQVNrRCxnQ0FBVCxHQUFnRTtBQUFBLE1BQXRCUCxlQUFzQix1RUFBSixFQUFJO0FBQ3JFLFNBQU9BLGVBQWUsQ0FBQ2EsTUFBaEIsQ0FDTCxVQUFDQyxJQUFELEVBQU9DLEdBQVAsRUFBZTtBQUNiLFFBQU1DLEtBQUssR0FBR1IsaUJBQWlCLENBQUNPLEdBQUQsQ0FBL0I7QUFDQSxRQUFNRSxLQUFLLEdBQUdMLGlCQUFpQixDQUFDRyxHQUFELENBQS9COztBQUNBLFFBQUlMLE1BQU0sQ0FBQ0MsUUFBUCxDQUFnQkssS0FBaEIsS0FBMEJOLE1BQU0sQ0FBQ0MsUUFBUCxDQUFnQk0sS0FBaEIsQ0FBOUIsRUFBc0Q7QUFDcERILE1BQUFBLElBQUksQ0FBQyxDQUFELENBQUosR0FBVUksSUFBSSxDQUFDQyxHQUFMLENBQVNMLElBQUksQ0FBQyxDQUFELENBQWIsRUFBa0JFLEtBQWxCLENBQVY7QUFDQUYsTUFBQUEsSUFBSSxDQUFDLENBQUQsQ0FBSixHQUFVSSxJQUFJLENBQUNFLEdBQUwsQ0FBU04sSUFBSSxDQUFDLENBQUQsQ0FBYixFQUFrQkcsS0FBbEIsQ0FBVjtBQUNEOztBQUNELFdBQU9ILElBQVA7QUFDRCxHQVRJLEVBVUwsQ0FBQ08sUUFBRCxFQUFXLENBQUNBLFFBQVosQ0FWSyxDQUFQO0FBWUQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMjAgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQge0FuYWx5emVyLCBEQVRBX1RZUEVTfSBmcm9tICd0eXBlLWFuYWx5emVyJztcblxuaW1wb3J0IHtnZXRTYW1wbGVEYXRhLCB0aW1lVG9Vbml4TWlsbGksIG5vdE51bGxvclVuZGVmaW5lZH0gZnJvbSAndXRpbHMvZGF0YS11dGlscyc7XG5cbmltcG9ydCB7cGFyc2VHZW9Kc29uUmF3RmVhdHVyZSwgZ2V0R2VvanNvbkZlYXR1cmVUeXBlc30gZnJvbSAnbGF5ZXJzL2dlb2pzb24tbGF5ZXIvZ2VvanNvbi11dGlscyc7XG5cbi8qKlxuICogUGFyc2UgZ2VvanNvbiBmcm9tIHN0cmluZ1xuICogQHBhcmFtIHthcnJheX0gc2FtcGxlcyBmZWF0dXJlIG9iamVjdCB2YWx1ZXNcbiAqIEByZXR1cm5zIHtib29sZWFufSB3aGV0aGVyIHRoZSBnZW9tZXRyeSBjb29yZGluYXRlcyBoYXMgbGVuZ3RoIG9mIDRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNvb3JkSGFzTGVuZ3RoNChzYW1wbGVzKSB7XG4gIGxldCBoYXNMZW5ndGg0ID0gdHJ1ZTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzYW1wbGVzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgaGFzTGVuZ3RoNCA9ICFzYW1wbGVzW2ldLmdlb21ldHJ5LmNvb3JkaW5hdGVzLmZpbmQoYyA9PiBjLmxlbmd0aCA8IDQpO1xuICAgIGlmICghaGFzTGVuZ3RoNCkge1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIHJldHVybiBoYXNMZW5ndGg0O1xufVxuXG4vKipcbiAqIENoZWNrIHdoZXRoZXIgZ2VvanNvbiBsaW5lc3RyaW5nJ3MgNHRoIGNvb3JkaW5hdGUgaXMgMSkgbm90IHRpbWVzdGFtcCAyKSB1bml4IHRpbWUgc3RhbXAgMykgcmVhbCBkYXRlIHRpbWVcbiAqIEBwYXJhbSB7YXJyYXl9IHRpbWVzdGFtcHMgYXJyYXkgdG8gYmUgdGVzdGVkIGlmIGl0cyBlbGVtZW50cyBhcmUgdGltZXN0YW1wXG4gKiBAcmV0dXJucyB7b2JqZWN0IHwgYm9vbGVhbn0gdGhlIHR5cGUgb2YgdGltZXN0YW1wOiB1bml4L2RhdGV0aW1lL2ludmFsaWQobm90IHRpbWVzdGFtcClcbiAqL1xuXG5leHBvcnQgZnVuY3Rpb24gY29udGFpblZhbGlkVGltZSh0aW1lc3RhbXBzKSB7XG4gIGNvbnN0IGZvcm1hdHRlZFRpbWVTdGFtcHMgPSB0aW1lc3RhbXBzLm1hcCh0cyA9PiAoe3RzfSkpO1xuICBjb25zdCBpZ25vcmVkRGF0YVR5cGVzID0gT2JqZWN0LmtleXMoREFUQV9UWVBFUykuZmlsdGVyKFxuICAgIHR5cGUgPT4gIVtEQVRBX1RZUEVTLlRJTUUsIERBVEFfVFlQRVMuREFURVRJTUVdLmluY2x1ZGVzKHR5cGUpXG4gICk7XG5cbiAgLy8gaWdub3JlIGFsbCB0eXBlcyBidXQgVElNRSB0byBpbXByb3ZlIHBlcmZvcm1hbmNlXG4gIGNvbnN0IGFuYWx5emVkVHlwZSA9IEFuYWx5emVyLmNvbXB1dGVDb2xNZXRhKGZvcm1hdHRlZFRpbWVTdGFtcHMsIFtdLCB7aWdub3JlZERhdGFUeXBlc30pWzBdO1xuXG4gIGlmICghYW5hbHl6ZWRUeXBlIHx8IGFuYWx5emVkVHlwZS5jYXRlZ29yeSAhPT0gJ1RJTUUnKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIHJldHVybiBhbmFseXplZFR5cGU7XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgZ2VvanNvbiBmZWF0dXJlcyBhcmUgdHJpcCBsYXllciBhbmltYXRhYmxlIGJ5IG1lZXRpbmcgMyBjb25kaXRpb25zXG4gKiBAcGFyYW0ge2FycmF5fSBhbGxEYXRhIGFycmF5IG9mIGdlb2pzb24gZmVhdHVyZSBvYmplY3RzXG4gKiBAcGFyYW0ge29iamVjdH0gZmllbGQgYXJyYXkgb2YgZ2VvanNvbiBmZWF0dXJlIG9iamVjdHNcbiAqIEByZXR1cm5zIHtib29sZWFufSB3aGV0aGVyIGl0IGlzIHRyaXAgbGF5ZXIgYW5pbWF0YWJsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNUcmlwR2VvSnNvbkZpZWxkKGFsbERhdGEgPSBbXSwgZmllbGQpIHtcbiAgaWYgKCFhbGxEYXRhLmxlbmd0aCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBjb25zdCBnZXRWYWx1ZSA9IGQgPT4gZFtmaWVsZC50YWJsZUZpZWxkSW5kZXggLSAxXTtcbiAgY29uc3QgbWF4Q291bnQgPSAxMDAwMDtcbiAgY29uc3Qgc2FtcGxlUmF3RmVhdHVyZXMgPVxuICAgIGFsbERhdGEubGVuZ3RoID4gbWF4Q291bnQgPyBnZXRTYW1wbGVEYXRhKGFsbERhdGEsIG1heENvdW50LCBnZXRWYWx1ZSkgOiBhbGxEYXRhLm1hcChnZXRWYWx1ZSk7XG5cbiAgY29uc3QgZmVhdHVyZXMgPSBzYW1wbGVSYXdGZWF0dXJlcy5tYXAocGFyc2VHZW9Kc29uUmF3RmVhdHVyZSkuZmlsdGVyKGYgPT4gZik7XG4gIGNvbnN0IGZlYXR1cmVUeXBlcyA9IGdldEdlb2pzb25GZWF0dXJlVHlwZXMoZmVhdHVyZXMpO1xuXG4gIC8vIGNvbmRpdGlvbiAxOiBjb250YWluIGxpbmUgc3RyaW5nXG4gIGlmICghZmVhdHVyZVR5cGVzLmxpbmUpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBjb25kaXRpb24gMjpzYW1wbGUgbGluZSBzdHJpbmdzIGNvbnRhaW4gNCBjb29yZGluYXRlc1xuICBpZiAoIWNvb3JkSGFzTGVuZ3RoNChmZWF0dXJlcykpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBjb25kaXRpb24gMzp0aGUgNHRoIGNvb3JkaW5hdGUgb2YgdGhlIGZpcnN0IGZlYXR1cmUgbGluZSBzdHJpbmdzIGlzIHZhbGlkIHRpbWVcbiAgY29uc3QgdHNIb2xkZXIgPSBmZWF0dXJlc1swXS5nZW9tZXRyeS5jb29yZGluYXRlcy5tYXAoY29vcmQgPT4gY29vcmRbM10pO1xuXG4gIHJldHVybiBCb29sZWFuKGNvbnRhaW5WYWxpZFRpbWUodHNIb2xkZXIpKTtcbn1cblxuLyoqXG4gKiBHZXQgdW5peCB0aW1lc3RhbXAgZnJvbSBhbmltYXRhYmxlIGdlb2pzb24gZm9yIGRlY2suZ2wgdHJpcCBsYXllclxuICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBkYXRhVG9GZWF0dXJlIGFycmF5IG9mIGdlb2pzb24gZmVhdHVyZSBvYmplY3RzLCBjYW4gYmUgbnVsbFxuICogQHJldHVybnMge3tkYXRhVG9UaW1lU3RhbXA6IEFycmF5W051bWJlcl0sIGFuaW1hdGlvbkRvbWFpbjogbnVsbCB8IEFycmF5PE51bWJlcj59fSB7ZGF0YVRvVGltZVN0YW1wOiBbXSwgYW5pbWF0aW9uRG9tYWluOiBudWxsfVxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VUcmlwR2VvSnNvblRpbWVzdGFtcChkYXRhVG9GZWF0dXJlKSB7XG4gIC8vIEFuYWx5emUgdHlwZSBiYXNlZCBvbiBjb29yZGluYXRlcyBvZiB0aGUgMXN0IGxpbmVTdHJpbmdcbiAgLy8gc2VsZWN0IGEgc2FtcGxlIHRyaXAgdG8gYW5hbHl6ZSB0aW1lIGZvcm1hdFxuICBjb25zdCBlbXB0eSA9IHtkYXRhVG9UaW1lU3RhbXA6IFtdLCBhbmltYXRpb25Eb21haW46IG51bGx9O1xuICBjb25zdCBzYW1wbGVUcmlwID0gZGF0YVRvRmVhdHVyZS5maW5kKFxuICAgIGYgPT4gZiAmJiBmLmdlb21ldHJ5ICYmIGYuZ2VvbWV0cnkuY29vcmRpbmF0ZXMgJiYgZi5nZW9tZXRyeS5jb29yZGluYXRlcy5sZW5ndGggPj0gM1xuICApO1xuXG4gIC8vIGlmIG5vIHZhbGlkIGdlb21ldHJ5XG4gIGlmICghc2FtcGxlVHJpcCkge1xuICAgIHJldHVybiBlbXB0eTtcbiAgfVxuXG4gIGNvbnN0IGFuYWx5emVkVHlwZSA9IGNvbnRhaW5WYWxpZFRpbWUoc2FtcGxlVHJpcC5nZW9tZXRyeS5jb29yZGluYXRlcy5tYXAoY29vcmQgPT4gY29vcmRbM10pKTtcblxuICBpZiAoIWFuYWx5emVkVHlwZSkge1xuICAgIHJldHVybiBlbXB0eTtcbiAgfVxuXG4gIGNvbnN0IHtmb3JtYXR9ID0gYW5hbHl6ZWRUeXBlO1xuICBjb25zdCBnZXRUaW1lVmFsdWUgPSBjb29yZCA9PlxuICAgIGNvb3JkICYmIG5vdE51bGxvclVuZGVmaW5lZChjb29yZFszXSkgPyB0aW1lVG9Vbml4TWlsbGkoY29vcmRbM10sIGZvcm1hdCkgOiBudWxsO1xuXG4gIGNvbnN0IGRhdGFUb1RpbWVTdGFtcCA9IGRhdGFUb0ZlYXR1cmUubWFwKGYgPT5cbiAgICBmICYmIGYuZ2VvbWV0cnkgJiYgQXJyYXkuaXNBcnJheShmLmdlb21ldHJ5LmNvb3JkaW5hdGVzKVxuICAgICAgPyBmLmdlb21ldHJ5LmNvb3JkaW5hdGVzLm1hcChnZXRUaW1lVmFsdWUpXG4gICAgICA6IG51bGxcbiAgKTtcblxuICBjb25zdCBhbmltYXRpb25Eb21haW4gPSBnZXRBbmltYXRpb25Eb21haW5Gcm9tVGltZXN0YW1wcyhkYXRhVG9UaW1lU3RhbXApO1xuXG4gIHJldHVybiB7ZGF0YVRvVGltZVN0YW1wLCBhbmltYXRpb25Eb21haW59O1xufVxuXG5mdW5jdGlvbiBmaW5kTWluRnJvbVNvcnRlZChsaXN0ID0gW10pIHtcbiAgcmV0dXJuIGxpc3QuZmluZChkID0+IG5vdE51bGxvclVuZGVmaW5lZChkKSAmJiBOdW1iZXIuaXNGaW5pdGUoZCkpIHx8IG51bGw7XG59XG5cbmZ1bmN0aW9uIGZpbmRNYXhGcm9tU29ydGVkKGxpc3QgPSBbXSkge1xuICBsZXQgaSA9IGxpc3QubGVuZ3RoIC0gMTtcbiAgd2hpbGUgKGkgPiAwKSB7XG4gICAgaWYgKG5vdE51bGxvclVuZGVmaW5lZChsaXN0W2ldKSAmJiBOdW1iZXIuaXNGaW5pdGUobGlzdFtpXSkpIHtcbiAgICAgIHJldHVybiBsaXN0W2ldO1xuICAgIH1cbiAgICBpLS07XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBbmltYXRpb25Eb21haW5Gcm9tVGltZXN0YW1wcyhkYXRhVG9UaW1lU3RhbXAgPSBbXSkge1xuICByZXR1cm4gZGF0YVRvVGltZVN0YW1wLnJlZHVjZShcbiAgICAoYWNjdSwgdHNzKSA9PiB7XG4gICAgICBjb25zdCB0c01pbiA9IGZpbmRNaW5Gcm9tU29ydGVkKHRzcyk7XG4gICAgICBjb25zdCB0c01heCA9IGZpbmRNYXhGcm9tU29ydGVkKHRzcyk7XG4gICAgICBpZiAoTnVtYmVyLmlzRmluaXRlKHRzTWluKSAmJiBOdW1iZXIuaXNGaW5pdGUodHNNYXgpKSB7XG4gICAgICAgIGFjY3VbMF0gPSBNYXRoLm1pbihhY2N1WzBdLCB0c01pbik7XG4gICAgICAgIGFjY3VbMV0gPSBNYXRoLm1heChhY2N1WzFdLCB0c01heCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gYWNjdTtcbiAgICB9LFxuICAgIFtJbmZpbml0eSwgLUluZmluaXR5XVxuICApO1xufVxuIl19